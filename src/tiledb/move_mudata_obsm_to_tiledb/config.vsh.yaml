name: move_mudata_obsm_to_tiledb
namespace: tiledb
scope: "private"
description: |
  Move .obsm items from a MuData modality to an existing tileDB database.
  The .obsm keys should not exist in the database yet; and the observations from the modality and 
  their order should match with what is already present the tiledb database.
authors:
  - __merge__: /src/authors/dries_schaumont.yaml
    roles: [ author, maintainer ]
argument_groups:
  - name: Input database
    description: "Open a tileDB-SOMA database by URI."
    arguments:
      - name: "--input_uri"
        type: string
        description: "A URI pointing to a TileDB-SOMA database."
        required: true
        example: "s3://bucket/path"
      - name: "--s3_region"
        description: |
          Region where the TileDB-SOMA database is hosted.
        type: string
        required: false
      - name: "--endpoint"
        type: string
        description: |
          Custom endpoint to use to connect to S3
        required: false
      - name: "--output_modality"
        type: string
        description: |
          TileDB-SOMA measurement to add the output to.
  - name: "MuData input"
    arguments:
      - name: "--input_mudata"
        type: file
        description: |
          MuData object to take the columns from. The observations and their order should
          match between the database and the input modality.
      - name: "--modality"
        type: string
        description: |
          Modality where to take the .obsm from.
      - name: "--obsm_input"
        type: string
        multiple: true
        description: |
          Keys from .obm to copy. The keys should not be present yet in the database.

resources:
  - type: python_script
    path: script.py
  - path: /src/utils/setup_logger.py
test_resources:
  - type: python_script
    path: test.py
  - path: /resources_test/tiledb/pbmc_1k_protein_v3_mms
    dest: tiledb/pbmc_1k_protein_v3_mms 
  - path: /resources_test/pbmc_1k_protein_v3/pbmc_1k_protein_v3_mms.h5mu
    dest: pbmc_1k_protein_v3/pbmc_1k_protein_v3_mms.h5mu
engines:
  - type: docker
    image: python:3.12
    setup:
      - type: python
        packages:
          - tiledbsoma
        __merge__: /src/base/requirements/anndata_mudata.yaml
    test_setup:
      - type: python
        packages:
          - moto[server]
          - boto3
    __merge__: [ /src/base/requirements/python_test_setup.yaml, .]
runners:
  - type: executable
    docker_run_args: ["--env", "AWS_ACCESS_KEY_ID", "--env", "AWS_SECRET_ACCESS_KEY"]
  - type: nextflow
    directives:
      label: [highmem, midcpu]